name: Autopilot - Release Train

on:
  schedule:
    - cron: "0 6 * * *"   # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

env:
  CI_BODY: |
    ## Release Candidate Ready (autogenerated)
    
    ### Changes (last 30 commits)
    {{NOTES}}
    
    ### Your decision
    Reply with one of:
    - ok
    - not ok + bullets of what's missing
    
    ### If "not ok", use this format
    - Missing:
    - Fix:
    - Nice-to-have:

jobs:
  release_candidate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build release notes draft
        id: notes
        run: |
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" -n 30 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Open Release Candidate issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const notes = `${{ steps.notes.outputs.notes }}`;

            let body = process.env.CI_BODY;
            body = body.replace("{{NOTES}}", notes);
    
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: res.data.number,
              body: `@mdklab ping â€” release candidate ready.`
            });
