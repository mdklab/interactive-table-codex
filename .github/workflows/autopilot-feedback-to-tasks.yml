name: Autopilot - Feedback to Tasks

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

env:
  CI_PROMPT: |
    @codex

    Convert the following release feedback into 3-10 implementable GitHub issues.
    Follow AGENTS.md and keep tasks small.

    Output STRICT JSON in code fence ```autopilot-backlog-json``` with fields:
    - title
    - body_markdown
    - labels (must include status:ready and autopilot:enabled)

    Feedback:
    {{COMMENT}}

jobs:
  feedback:
    runs-on: ubuntu-latest
    steps:
      - name: Convert release feedback into tasks
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const comment = (context.payload.comment.body || "").trim();

            const isRC = (issue.labels || []).some(l => l.name === "status:release-candidate");
            if (!isRC) return;

            if (/^(ship|ok)/i.test(comment)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: "Acknowledged. (Wire this to prod deploy when you're ready.)"
              });
              return;
            }

            let prompt = process.env.CI_PROMPT || "";
            prompt = prompt.replace("{{COMMENT}}", () => comment);

            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: prompt
            });
