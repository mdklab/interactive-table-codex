name: Autopilot - PR Sync

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  issues: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Link PR to issue and request Codex review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CODEX_BOT_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            const body = pr.body || "";
            const m = body.match(/Fixes\\s+#(\\d+)/i);
            if (!m) return;

            const issueNumber = Number(m[1]);

            // Mark PR as autopilot-enabled
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr.number,
              labels: ["autopilot:enabled"]
            }).catch(()=>{});

            // Move issue status -> review
            await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: "status:in-progress" }).catch(()=>{});
            await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels: ["status:review"] }).catch(()=>{});

            await github.rest.issues.createComment({
              owner, repo, issue_number: issueNumber,
              body: `PR opened: #${pr.number}`
            });

            // Ask Codex to review
            await github.rest.issues.createComment({
              owner, repo, issue_number: pr.number,
              body: "@codex review"
            });
